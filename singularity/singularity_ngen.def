Bootstrap: docker
From: rockylinux:9.1

%environment
    export TROUTE_REPO="CIROH-UA/t-route"
    export TROUTE_BRANCH="ngiab"
    export NGEN_REPO="CIROH-UA/ngen"
    export NGEN_BRANCH="ngiab"
    export PATH="/usr/lib64/openmpi/bin:$PATH"
    export PATH="/root/.cargo/bin:$PATH"
    export PATH="/ngen/.venv/bin:$PATH"
    export UV_INSTALL_DIR="/root/.cargo/bin"
    export UV_COMPILE_BYTECODE=1

%post
    # Set environment variables for build
    TROUTE_REPO="CIROH-UA/t-route"
    TROUTE_BRANCH="ngiab"
    NGEN_REPO="CIROH-UA/ngen"
    NGEN_BRANCH="ngiab"
    export UV_INSTALL_DIR="/root/.cargo/bin"
    export UV_COMPILE_BYTECODE=1
    export PATH="/root/.cargo/bin:$PATH"

    # Install UV early
    curl -LsSf https://astral.sh/uv/install.sh | sh
    uv self update

    # Install system dependencies
    echo "max_parallel_downloads=10" >> /etc/dnf/dnf.conf
    dnf update -y
    dnf install -y epel-release
    dnf config-manager --set-enabled crb
    dnf install -y sudo vim gcc gcc-c++ make cmake ninja-build tar git gcc-gfortran libgfortran sqlite sqlite-devel \
        python3 python3-devel python3-pip \
        bzip2 expat expat-devel flex bison udunits2 udunits2-devel zlib-devel \
        wget openmpi openmpi-devel hdf5 hdf5-devel netcdf netcdf-devel \
        netcdf-fortran netcdf-fortran-devel netcdf-cxx netcdf-cxx4-openmpi netcdf-cxx-devel lld clang
    
    # Create necessary directories
    mkdir -p /ngen /ngen/t-route /dmod/datasets /dmod/datasets/static /dmod/shared_libs /dmod/bin /dmod/utils/

    # Build Boost (headers only)
    cd /
    wget https://archives.boost.io/release/1.86.0/source/boost_1_86_0.tar.gz
    tar -xzf boost_1_86_0.tar.gz
    cd boost_1_86_0
    ./bootstrap.sh && ./b2 headers
    export BOOST_ROOT=/boost_1_86_0

    # Setup for troute
    cd /ngen
    export FC=gfortran
    export NETCDF=/usr/lib64/gfortran/modules/
    ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    # Setup Python venv and install troute requirements
    uv venv
    export PATH="/ngen/.venv/bin:$PATH"
    uv pip install -r "https://raw.githubusercontent.com/${TROUTE_REPO}/refs/heads/${TROUTE_BRANCH}/requirements.txt"

    # Build t-route
    cd /ngen/t-route
    git clone --depth 1 --single-branch --branch $TROUTE_BRANCH https://github.com/$TROUTE_REPO.git .
    echo $(git remote get-url origin | sed 's/\.git$//' | awk '{print $0 "/tree/" }' | tr -d '\n' && git rev-parse HEAD) >> /tmp/troute_url
    git submodule update --init --depth 1
    uv pip install build wheel

    # Modify and run compiler
    sed -i 's/build_[a-z]*=/#&/' compiler.sh
    ./compiler.sh no-e

    # Build troute wheels
    uv pip install --config-setting='--build-option=--use-cython' src/troute-network/
    uv build --wheel --config-setting='--build-option=--use-cython' src/troute-network/
    uv pip install --no-build-isolation --config-setting='--build-option=--use-cython' src/troute-routing/
    uv build --wheel --no-build-isolation --config-setting='--build-option=--use-cython' src/troute-routing/
    uv build --wheel --no-build-isolation src/troute-config/
    uv build --wheel --no-build-isolation src/troute-nwm/

    # Copy wheels to /tmp for later installation
    cp src/troute-*/dist/*.whl /tmp/

    # Clone and build NGEN
    cd /ngen
    git clone --single-branch --branch $NGEN_BRANCH https://github.com/$NGEN_REPO.git
    cd ngen
    git submodule update --init --recursive --depth 1
    echo $(git remote get-url origin | sed 's/\.git$//' | awk '{print $0 "/tree/" }' | tr -d '\n' && git rev-parse HEAD) >> /tmp/ngen_url

    # Add OpenMPI to PATH for build
    export PATH="${PATH}:/usr/lib64/openmpi/bin"

    # Define build arguments
    export COMMON_BUILD_ARGS="-DNGEN_WITH_EXTERN_ALL=ON \
        -DNGEN_WITH_NETCDF:BOOL=ON \
        -DNGEN_WITH_BMI_C:BOOL=ON \
        -DNGEN_WITH_BMI_FORTRAN:BOOL=ON \
        -DNGEN_WITH_PYTHON:BOOL=ON \
        -DNGEN_WITH_ROUTING:BOOL=ON \
        -DNGEN_WITH_SQLITE:BOOL=ON \
        -DNGEN_WITH_UDUNITS:BOOL=ON \
        -DUDUNITS_QUIET:BOOL=ON \
        -DNGEN_WITH_TESTS:BOOL=OFF \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=. \
        -DCMAKE_CXX_FLAGS='-fuse-ld=lld'"

    # Build serial version
    cmake -G Ninja -B cmake_build_serial -S . ${COMMON_BUILD_ARGS} -DNGEN_WITH_MPI:BOOL=OFF
    cmake --build cmake_build_serial --target all -- -j $(nproc)

    # Build parallel version
    dnf install -y netcdf-cxx4-openmpi-devel
    export MPI_BUILD_ARGS="-DNGEN_WITH_MPI:BOOL=ON \
        -DNetCDF_ROOT=/usr/lib64/openmpi \
        -DCMAKE_PREFIX_PATH=/usr/lib64/openmpi \
        -DCMAKE_LIBRARY_PATH=/usr/lib64/openmpi/lib"
    
    cmake -G Ninja -B cmake_build_parallel -S . ${COMMON_BUILD_ARGS} ${MPI_BUILD_ARGS} \
        -DNetCDF_CXX_INCLUDE_DIR=/usr/include/openmpi-$(arch) \
        -DNetCDF_INCLUDE_DIR=/usr/include/openmpi-$(arch)
    cmake --build cmake_build_parallel --target all -- -j $(nproc)

    # Setup final directories with globstar
    shopt -s globstar
    cp -a ./extern/**/cmake_build/*.so* /dmod/shared_libs/. || true
    cp -a ./extern/noah-owp-modular/**/*.TBL /dmod/datasets/static || true
    cp -a ./cmake_build_parallel/ngen /dmod/bin/ngen-parallel || true
    cp -a ./cmake_build_serial/ngen /dmod/bin/ngen-serial || true
    cp -a ./cmake_build_parallel/partitionGenerator /dmod/bin/partitionGenerator || true
    cp -ar ./utilities/* /dmod/utils/
    cd /dmod/bin && \
        (stat ngen-parallel && ln -s ngen-parallel ngen) || (stat ngen-serial && ln -s ngen-serial ngen)

    # Setup library path and symlinks
    echo "/dmod/shared_libs/" >> /etc/ld.so.conf.d/ngen.conf && ldconfig -v
    ln -s /dmod/bin/ngen /usr/local/bin/ngen
    chmod a+x /dmod/bin/*

    # Install troute wheels from /tmp
    cd /ngen
    uv pip install --no-cache-dir /tmp/*.whl netCDF4==1.6.3
    rm -rf /tmp/*.whl

    # Install numpy matching ngen's expected version
    uv pip install numpy==$(/dmod/bin/ngen --info | grep -e 'NumPy Version: ' | cut -d ':' -f 2 | uniq | xargs)

    # Install lstm (no directory copying needed)
    uv pip install --no-cache-dir /ngen/ngen/extern/lstm/lstm --extra-index-url https://download.pytorch.org/whl/cpu

    # Clone and process LSTM weights
    git clone --depth=1 --branch example_weights https://github.com/ciroh-ua/lstm.git /lstm_weights
    
    # Convert weights using rust conversion script
    # Download the conversion script locally
    curl -L https://raw.githubusercontent.com/CIROH-UA/rust-lstm-1025/refs/tags/v0.1.0/scripts/convert.py -o /tmp/convert.py
    # Optionally verify the hash (uncomment and set the correct hash if desired)
    # echo "EXPECTED_HASH  /tmp/convert.py" | sha256sum -c -
    uv run --with pyyaml --with numpy --with torch --extra-index-url https://download.pytorch.org/whl/cpu \
        /tmp/convert.py all /lstm_weights/trained_neuralhydrology_models/
    rm -f /tmp/convert.py
    # Replace relative paths with absolute paths
    shopt -s globstar
    sed -i 's|\.\.|/ngen/ngen/extern/lstm|g' /lstm_weights/trained_neuralhydrology_models/**/config.yml

    # Replace the noaa-owp example weights
    rm -rf /ngen/ngen/extern/lstm/trained_neuralhydrology_models
    cp -r /lstm_weights/trained_neuralhydrology_models /ngen/ngen/extern/lstm/trained_neuralhydrology_models

    # Build rust-lstm
    cd /
    curl https://sh.rustup.rs -sSf | bash -s -- -y
    source $HOME/.cargo/env
    mkdir -p /build
    cd /build
    git clone --depth=1 https://github.com/aaraney/bmi-rs
    git clone --depth=1 --branch bmi_rs_pin https://github.com/ciroh-ua/rust-lstm-1025
    cd /build/rust-lstm-1025
    cargo build --release
    
    # Copy rust-lstm library to shared libs
    cp /build/rust-lstm-1025/target/release/librust_lstm_1025.so /dmod/shared_libs/librust_lstm_1025.so
    ldconfig -v

    # Set permissions
    chmod -R 755 /ngen /dmod /usr/local/bin /ngen/.venv
    chmod 755 /ngen/HelloNGEN.sh /dmod/bin/* /usr/local/bin/ngen

    # Add custom prompt
    echo "export PS1='\u\[\033[01;32m\]@ngiab_dev\[\033[00m\]:\[\033[01;35m\]\W\[\033[00m\]\$ '" >> ~/.bashrc

    # Cleanup build artifacts
    rm -rf /boost_1_86_0* /build /lstm_weights

%files
    templates/guide/HelloNGEN.sh /ngen/HelloNGEN.sh

%runscript
    exec /ngen/HelloNGEN.sh "$@"